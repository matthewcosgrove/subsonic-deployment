- type: replace
  path: /instance_groups/name=jumpbox/jobs/-
  value:
    name: pre-start-script
    release: os-conf
    properties:
      script: |-
          #!/bin/bash
          chmod 1777 /tmp # https://github.com/cloudfoundry/bosh-linux-stemcell-builder/issues/39
          # bosh cli injected args
          UBUNTU_USER_HOME_DIR="((jumpbox_home))"
          SUBSONIC_SERVER_DOMAIN="((subsonic_domain))"
          SUBSONIC_JVM_START_UP_ARGS='((subsonic_args))'
          # start ubuntu script - agnostic of bosh cli usage
          : "${UBUNTU_USER_HOME_DIR:? UBUNTU_USER_HOME_DIR must be set}"
          : "${SUBSONIC_SERVER_DOMAIN:? SUBSONIC_SERVER_DOMAIN must be set to the DNS being used to refer to this instance which should be configured in nginx e.g. music.mydomain.com }"
          : "${SUBSONIC_JVM_START_UP_ARGS:? SUBSONIC_JVM_START_UP_ARGS must be set to override the defaults in /etc/default/subsonic}"
          apt-get -qq update
          apt -yqq install python
          dropbox_cli=/usr/local/bin/dropbox.py
          [ ! -f $dropbox_cli ] && wget -O $dropbox_cli "https://www.dropbox.com/download?dl=packages/dropbox.py"
          chmod +x $dropbox_cli

          # https://linoxide.com/linux-how-to/install-dropbox-ubuntu/
          cat <<EOF >/etc/systemd/system/dropbox.service
          [Unit]
          Description=Dropbox Service
          After=network.target

          [Service]
          ExecStart=/bin/sh -c '/usr/local/bin/dropbox.py start'
          ExecStop=/bin/sh -c '/usr/local/bin/dropbox.py stop'
          PIDFile=${UBUNTU_USER_HOME_DIR}/.dropbox/dropbox.pid
          User=jumpbox
          Group=jumpbox
          Type=forking
          Restart=on-failure
          RestartSec=5
          StartLimitInterval=60s
          StartLimitBurst=3

          [Install]
          WantedBy=multi-user.target
          EOF

          systemctl daemon-reload
          systemctl enable dropbox
          dropbox_up_script=${UBUNTU_USER_HOME_DIR}/ubuntu_dropbox_up.sh
          if [ ! -f $dropbox_up_script ]; then
            wget -O $dropbox_up_script https://gist.githubusercontent.com/matthewcosgrove/7a98cc996f8d7e421dd392c8d736b5eb/raw/5faa17863b61e75214c73fca0047360936b36441/ubuntu_dropbox_up.sh
            chmod +x $dropbox_up_script
            chown jumpbox:jumpbox $dropbox_up_script
          else
            systemctl start dropbox
          fi

          # https://www.linuxbabe.com/ubuntu/install-subsonic-media-server-ubuntu-18-04-https
          apt -yqq install openjdk-8-jre
          subsonic_version=6.1.5
          wget -O subsonic.deb https://s3-eu-west-1.amazonaws.com/subsonic-public/download/subsonic-${subsonic_version}.deb
          dpkg -i subsonic.deb
          # change default root user, and do so idempotently
          sed -i '/SUBSONIC_USER/ s/=.*$/=jumpbox/' /etc/default/subsonic
          subsonic_jvm_start_up_args_with_ampersand_escaped_for_sed=${SUBSONIC_JVM_START_UP_ARGS//&/\\&} # https://stackoverflow.com/a/44375021/752167
          # as values contain / use different sed delimeter #
          sed -i '/^SUBSONIC_ARGS/ s#=.*$#="'"$subsonic_jvm_start_up_args_with_ampersand_escaped_for_sed"'"#' /etc/default/subsonic
          systemctl restart subsonic

          # Either enable IPv6 or change the nginx configuration issue --> https://serverfault.com/a/828014
          # Means we know the nginx install will fail so install and swallow failure
          apt -yqq install nginx || true # https://stackoverflow.com/a/11231970/752167
          sed -i '/:80 /s/^/#/' /etc/nginx/sites-enabled/default
          systemctl restart nginx || true
          systemctl start nginx || true
          # ubuntu 16.04 bug --> https://bugs.launchpad.net/ubuntu/+source/nginx/+bug/1581864
          # also see https://stackoverflow.com/a/42084804/752167
          mkdir /etc/systemd/system/nginx.service.d
          printf "[Service]\nExecStartPost=/bin/sleep 0.1\n" > /etc/systemd/system/nginx.service.d/override.conf
          systemctl daemon-reload
          systemctl restart nginx
          # check with 'netstat -plunt | grep nginx'

          # 'EOF' vs EOF with escaping --> https://stackoverflow.com/a/25903579/752167 and https://unix.stackexchange.com/a/405254/308152
          cat <<EOF >/etc/nginx/conf.d/subsonic-proxy.conf
          server {
                  listen 80;
                  server_name $SUBSONIC_SERVER_DOMAIN;

                  location / {
                          proxy_pass http://127.0.0.1:4040;
                          proxy_set_header Host \$http_host;
                          proxy_set_header X-Real-IP \$remote_addr;
                          proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                          proxy_set_header X-Forwarded-Proto \$scheme;
                  }
          }
          EOF
          systemctl reload nginx
